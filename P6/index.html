<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  	<style>
  	/*CSS STYLING*/
  	svg {
  		background-color: beige;
  		margin-left: auto;
  		margin-right: auto;
  		display: block;
  	}

    .labels {
      font-family: sans-serif;
      font-size: 12px;
      fill: green;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }

    .axis text {
      font-family: sans-serif;
      font-size: 12px;
    }

    .line {
      fill: none;
      stroke: steelblue;
      stroke-linejoin: round;
      stroke-linecap: round;
      stroke-width: 1.5;
    }

  	</style>
  	<script type="text/javascript">
  		function plot_data (data) {

        "use strict";
  			var margin = 100,
            width = 1200 - margin,
  					height = 600 - margin;

        d3.select("body")
          .append("h2")
          .text("Flight Delays");

        d3.select("body")
          .append("h4")
          .text("By Trevor Cook");



        // Group by year
        var nested = d3.nest()
                        .key(function(d) {
                          return d.carrier_name;
                          // return d.year.getUTCFullYear();
                        })
                        .entries(data);

        // Create a set to remove duplicates
        var unique_names = new Set();
        var dropdown_names = [];

        for (var i = 0; i < nested.length; i++) {
          if (!unique_names.has(nested[i])) {
            unique_names.add(nested[i])
            dropdown_names.push(nested[i]);
          };
        };


        function key_func(d) {
                return d['key'];
            }


        // // ### DROPDOWN ###
        var dropdown = d3.select("body")
                          .append("div")
                          .append("select")
                          .attr("class", "dropdown")
                          .attr("id", "dropdown");
                          // .attr("onchange", function() {
                          //   var newData = eval(d3.select(this).property("value"));
                          //   update_data(newData);
                          // });



        // dropdown.property("value", "AirTran Airways Corporation");

        var options = dropdown.selectAll("option")
                              .data(dropdown_names)
                              .enter()
                              .append("option")
                              .text(function(d) { return d.key; })
                              .attr("value", function(d) { return d.key; });










        // extent returns the min and max -> use for axis
        var time_extent = d3.extent(data, function(d) {
          return d.year;
        });

        // Find range of attendance column
        var count_extent = d3.extent(data, function(d) {
          return d.minsDelayed;
        });

        // Create x-axis scale mapping dates -> pixels
        var xScale = d3.time.scale()
          .range([margin, width])
          .domain(time_extent);

        // Create x-axis scale mapping attendance -> pixels
        var yScale = d3.scale.linear()
          .range([height, margin])
          .domain(count_extent);


        var xAxis = d3.svg.axis()
                      .scale(xScale)
                      .ticks(10);


        var yAxis = d3.svg.axis()
                      .scale(yScale)
                      .orient("left")
                      .ticks(10);



        var line = d3.svg.line()
                      .x(function(d) { return xScale(d.year); })
                      .y(function(d) { return yScale(d.minsDelayed); });


        // Draw chart frame as an svg element
        var svg = d3.select("body")
                    .append("svg")
                    .attr("width", width + margin)
                    .attr("height", height + margin)
                    .append("g");


        // Append circles
        var circles = svg.selectAll("circle")
                          .data(data);


        circles.enter()
              .append("circle")
              .transition()
              .duration(500)
              .attr("cx", function(d) { return xScale(d['year']); })
              .attr("cy", function(d) { return yScale(d['minsDelayed']); })
              .attr("r", 5);


        // Create x Axis
        d3.select("svg")
          .append("g")
          .attr('id', 'xAxis')
          .attr("class", "axis")
          .attr('transform', "translate(0," + height + ")")
          .call(xAxis);

        // Create y Axis
        d3.select("svg")
          .append("g")
          .attr('id', 'yAxis')
          .attr("class", "axis")
          .attr('transform', "translate(" + margin + ",0)")
          .call(yAxis);
















        // ############################################################

        function update_data (newData) {


          var filtered = nested.filter(function(d) {
            return new Array(d['key']) === newData;
          });



          // extent returns the min and max -> use for axis
          var time_extent = d3.extent(newData, function(d) {
            return d.values['year'];
          });

          // Find range of attendance column
          var count_extent = d3.extent(newData, function(d) {
            return d.values['minsDelayed'];
          });

          // Create x-axis scale mapping dates -> pixels
          var xScale = d3.time.scale()
            .range([margin, width])
            .domain(time_extent);

          // Create x-axis scale mapping attendance -> pixels
          var yScale = d3.scale.linear()
            .range([height, margin])
            .domain(count_extent);


          var xAxis = d3.svg.axis()
                        .scale(xScale)
                        .ticks(10);


          var yAxis = d3.svg.axis()
                        .scale(yScale)
                        .orient("left")
                        .ticks(10);



          var line = d3.svg.line()
                        .x(function(d) { return xScale(d.values['year']); })
                        .y(function(d) { return yScale(d.values['minsDelayed']); });


          // Draw chart frame as an svg element
          var svg = d3.select("body")
                      .append("svg")
                      .attr("width", width + margin)
                      .attr("height", height + margin)
                      .append("g");


          // Append circles
          var circles = svg.selectAll("circle")
                            .data(filtered, key_func);

          circles.exit().remove();

          circles.enter()
                .append("circle")
                .transition()
                .duration(500)
                .attr("cx", function(d) { return xScale(d.values['year']); })
                .attr("cy", function(d) { return yScale(d.values['minsDelayed']); })
                .attr("r", 5);


          // Create x Axis
          d3.select("svg")
            .append("g")
            .attr('id', 'xAxis')
            .attr("class", "axis")
            .attr('transform', "translate(0," + height + ")")
            .call(xAxis);

          // Create y Axis
          d3.select("svg")
            .append("g")
            .attr('id', 'yAxis')
            .attr("class", "axis")
            .attr('transform', "translate(" + margin + ",0)")
            .call(yAxis);


        }



        // ############################################################

        // // // Add TEXT to lables
        // // svg.selectAll("text")
        // //   .data(data)
        // //   .enter()
        // //   .append("text")
        // //   .text(function(d) { return d['carrier_name']; })
        // //   .attr("class", "labels")
        // //   .attr("x", function(d) { return xScale(d['year']); })
        // //   .attr("y", function(d) { return yScale(d['minsDelayed']); });


        // // // Append LINES
        // // svg.append("path")
        // //     .attr("class", "line")
        // //     .attr("d", line(data));



  		}

  	</script>
	</head>
<body>
	<script type="text/javascript">
  format = d3.time.format("%Y")

  // Load CSV data
  d3.csv("airline_delays_grouped.csv", function(d) {
    d['carrier_name'] = d['carrier_name'];
    d['year'] = format.parse(d['year']);
    d['minsDelayed'] = +d['minsDelayed'];

    return d;
	}, plot_data);

	</script>
</body>
</html>
